<div class="dangerous-goods">
    <div class="dangerous-goods__breadcrumbs breadcrumbs">
        <a href="#" class="dangerous-goods__breadcrumb breadcrumbs__item">Пункт 1</a> /
        <a href="#" class="dangerous-goods__breadcrumb breadcrumbs__item">Пункт 2</a> /
        <span class="dangerous-goods__breadcrumb breadcrumbs__item breadcrumbs__item_current"> Пункт 3</span>
    </div>
    
    <h1 class="title dangerous-goods__title">Перевалка опасных грузов</h1>
    
    <div class="tabs dangerous-goods__tabs">
        <div data-tabs-open="import-permit" class="tab active">Разрешение на завоз</div>
        <div data-tabs-open="documents" class="tab">Документы</div>
        <div data-tabs-open="fastening-schemes" class="tab">Схемы крепления</div>
        <div class="tabs__floatr"></div>
    </div>
    
    <div data-tabs="import-permit">
        <h2 class="dangerous-goods__caption">Разрешение на завоз опасного груза</h2>
      
        <div class="filters-subtitle">Контактные данные</div>
        <form id="dangerous_goods" class="filters-row">
            <input type="hidden" name="form_id" value="dangerous_goods">
            <input name="surname" class="input input_secondary" placeholder="Фамилия*" type="text" role="presentation" autocomplete="off">
            <input name="name" class="input input_secondary" placeholder="Имя*" type="text" role="presentation" autocomplete="off">
            <input name="patronymic" class="input input_secondary" placeholder="Отчество*" type="text" role="presentation" autocomplete="off">
            <input name="phone" data-mask="+{7} (000) 000-00-00" class="input input_secondary" placeholder="Контактный телефон*" type="text" role="presentation" autocomplete="off">
            <input name="email" class="input input_secondary" placeholder="Электронная почта*" type="text" role="presentation" autocomplete="off">
        </form>
        
        <div class="filters-subtitle">Грузы в контейнере</div>
        <form id="permission-form" class="filters-row">
            <div class="dangerous-goods-ooh">
                <input data-mask="number" name="code" type="text" class="input input_secondary" placeholder="Ввести номер ООН" role="presentation" autocomplete="off">
                <div class="select select_string dangerous-goods-ooh__select" data-select-disable-close>
                    <input name="code" type="hidden" class="select__input">
                    <div class="select__wrapper dangerous-goods-ooh__items">
                        <div class="select__item btn btn_secondary" data-value="">Выберите группу упаковки</div>
                    </div>
                </div>
            </div>
            
            <div class="select select_secondary">
                <div class="select__value"></div>
                <input name="packingGroup" type="hidden" class="select__input">
                <div class="select__wrapper">
                    <div class="select__item btn btn_secondary" data-value="">Выберите группу упаковки</div>
                </div>
                <div class="select__daw">@@include('../components/svg/daw.html')</div>
            </div>
            <button class="btn btn_primary btn_w-100 btn_large" type="submit">Добавить</button>
        </form>
        
        <div class="dangerous-goods__table" style="display: none">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>НОМЕР ООН</th>
                            <th>ГРУППА УПАКОВКИ</th>
                            <th>Название опасного вещества</th>
                        </tr>
                    </thead>
                    <tbody id="table-permission-body"></tbody>
                </table>
            </div>
            
            <button id="request-permission" class="btn btn_primary dangerous-goods__table-btn" type="button">Запросить разрешение</button>
        </div>
        
        <div class="dangerous-goods__permissions" style="display: none"></div>
    </div>
    
    <div data-tabs="documents" class="file-list" style="display: none;">
        <a href="#" class="file-block file-list__file" target="_blank">
            <div class="file-block__file file-list__type">
                @@include('../components/svg/file.html')
                <div class="file-block__type">pdf</div>
            </div>

            <div class="file-block__content">
                <div class="file-block__title file-list__title">Заголовок (H4) Название документа. Размер может быть любой количество символ и строк не ограничено. Название документа. Размер может быть любой количество символ и строк не ограничено.</div>

                <div class="file-block__size">
                    32,5 kB
                    <div class="file-block__download">@@include('../components/svg/download.html')</div>
                </div>
            </div>
        </a>
        
        <a href="#" class="file-block file-list__file" target="_blank">
            <div class="file-block__file file-list__type">
                @@include('../components/svg/file.html')
                <div class="file-block__type">pdf</div>
            </div>

            <div class="file-block__content">
                <div class="file-block__title file-list__title">Заголовок (H4) Название документа. Размер может быть любой количество символ и строк не ограничено. Название документа. Размер может быть любой количество символ и строк не ограничено.</div>

                <div class="file-block__size">
                    32,5 kB
                    <div class="file-block__download">@@include('../components/svg/download.html')</div>
                </div>
            </div>
        </a>
        
        <a href="#" class="file-block file-list__file" target="_blank">
            <div class="file-block__file file-list__type">
                @@include('../components/svg/file.html')
                <div class="file-block__type">pdf</div>
            </div>

            <div class="file-block__content">
                <div class="file-block__title file-list__title">Заголовок (H4) Название документа. Размер может быть любой количество символ и строк не ограничено. </div>

                <div class="file-block__size">
                    32,5 kB
                    <div class="file-block__download">@@include('../components/svg/download.html')</div>
                </div>
            </div>
        </a>
        
        <a href="#" class="file-block file-list__file" target="_blank">
            <div class="file-block__file file-list__type">
                @@include('../components/svg/file.html')
                <div class="file-block__type">pdf</div>
            </div>

            <div class="file-block__content">
                <div class="file-block__title file-list__title">Заголовок (H4) Название документа. Размер может быть любой количество символ и строк не ограничено. Название документа. Размер может быть любой количество символ и строк не ограничено. Название документа. Размер может быть любой количество символ и строк не ограничено. Название документа. Размер может быть любой количество символ и строк не ограничено.</div>

                <div class="file-block__size">
                    32,5 kB
                    <div class="file-block__download">@@include('../components/svg/download.html')</div>
                </div>
            </div>
        </a>
        
        <a href="#" class="file-block file-list__file" target="_blank">
            <div class="file-block__file file-list__type">
                @@include('../components/svg/file.html')
                <div class="file-block__type">pdf</div>
            </div>

            <div class="file-block__content">
                <div class="file-block__title file-list__title">Заголовок (H4) Название документа. Размер может быть любой количество символ и строк не ограничено. Название документа. Размер может быть любой количество символ и строк не ограничено.</div>

                <div class="file-block__size">
                    32,5 kB
                    <div class="file-block__download">@@include('../components/svg/download.html')</div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="accordion-wrapper" data-tabs="fastening-schemes" style="display: none;">
        <div class="accordion accordion_small">
            <div class="accordion__header">
                <h4 class="accordion__title">Заголовок (H4) Название группы документов. Размер может быть любой количество символ и строк не ограничено.</h4>

                <div class="accordion__btn">
                    @@include('../components/svg/daw-bold.html')
                </div>
            </div>
            
            <div class="accordion__container">
                <div class="accordion__wrapper">
                    ...
                </div>
            </div>
        </div>
        
        <div class="accordion accordion_small">
            <div class="accordion__header">
                <h4 class="accordion__title">Заголовок (H4) Название группы документов. Размер может быть любой количество символ и строк не ограничено.</h4>

                <div class="accordion__btn">
                    @@include('../components/svg/daw-bold.html')
                </div>
            </div>
            
            <div class="accordion__container">
                <div class="accordion__wrapper">
                    ...
                </div>
            </div>
        </div>
        
        <div class="accordion accordion_small">
            <div class="accordion__header">
                <h4 class="accordion__title">Заголовок (H4) Название группы документов. Размер может быть любой количество символ и строк не ограничено.</h4>

                <div class="accordion__btn">
                    @@include('../components/svg/daw-bold.html')
                </div>
            </div>

            <div class="accordion__container">
                <div class="accordion__wrapper">
                    ...
                </div>
            </div>
        </div>
    </div>
</div>

<script id="permission-card-template" type="text/template">
    <div class="dangerous-goods-permission__content">
        <div class="dangerous-goods-permission__col">
            <div class="subtitle">Название</div>
            <h3 class="dangerous-goods-permission__title">{{ shippingName }}</h3>
            <div class="dangerous-goods-permission__description">{{ portDescription }}</div>
            <div class="subtitle">Прием в порт</div>
            <div class="dangerous-goods-permission__depiction">{{ cargoProperties }}</div>
        </div>
        <div class="dangerous-goods-permission__col">
            <div class="subtitle">Номер ООН</div>
            <div class="dangerous-goods-permission__value">{{ unCode }}</div>

            <div class="subtitle">Группа упаковки</div>
            <div class="dangerous-goods-permission__value">{{ packingGroup }}</div>

            <div class="subtitle">Класс или подкласс</div>
            <div class="dangerous-goods-permission__value">{{ classOrSubclass }}</div>

            <div class="dangerous-goods-permission__additional-wrapper">
                <div class="dangerous-goods-permission__additional">
                    <div class="subtitle">Доп виды опасности</div>
                    {{ additionalInformation }}
                </div>
                <div class="dangerous-goods-permission__additional">
                    <div class="subtitle">Запрещен прием по&nbsp;ЖД</div>
                    {{ receptionByRailway }}
                </div>
                <div class="dangerous-goods-permission__additional">
                    <div class="subtitle">Инструкции по&nbsp;цистернам</div>
                    {{ tankerInstructions }}
                </div>
            </div>
        </div>
    </div>
    {{ footer }}
</script>

<script id="permission-row-template" type="text/template">
    <td>{{ pos }}</td>
    <td>{{ code }}</td>
    <td>{{ packingGroup }}</td>
    <td>
        {{ select }}
    </td>
    <td class="dangerous-goods__cross-wrapper"><div class="dangerous-goods__cross">@@include('../components/svg/cross.html')</div></td>
</script>

<script id="permission-row-select-template" type="text/template">
    <div class="select select_string error" data-permission-card-select>
        <div class="select__value">Выберите название опасного вещества*</div>
        <input name="{{ select-id }}" type="hidden" class="select__input" value="{{ select-value }}">
        <div class="select__wrapper">
            <div class="select__item btn btn_secondary permission-card-default-value" data-value="">Выберите название опасного вещества*</div>
            {{ select-items }}
        </div>
        <div class="select__daw">@@include('../components/svg/daw.html')</div>
    </div>
</script>

<script data-skip-moving src="/js/dangerous.js" type="text/javascript"></script>

<script defer>
    document.addEventListener('DOMContentLoaded', function() {
        const dangerousGoodsKeys = Object.keys(dangerousGoods);
        const oohInput = document.querySelector('[name="code"]');
        const oohSelectWrapper = document.querySelector('.dangerous-goods-ooh__items');
        const oohSelect = selects['permission-form_code'];
        const groupSelect = selects['permission-form_packingGroup'];
        const dangerousGoodsOption = { value: '', text: dangerousGoodsGroups['default'] };
        const tablePermissionsHtml = document.querySelector('#table-permission-body');
        const tableWrapper = document.querySelector('.dangerous-goods__table');
        const permissionsRowTemplate = document.querySelector('#permission-row-template').innerHTML;
        const permissionsSelectTemplate = document.querySelector('#permission-row-select-template').innerHTML;
        const dangerousGoodsForm = document.querySelector('#dangerous_goods');
        const permissionsHtml = document.querySelector('.dangerous-goods__permissions');
        const permissionsTemplate = document.querySelector('#permission-card-template').innerHTML;
        const tablePermissions = [];
        let dirtyGroupSelect = false, dangerousGoodsSelected;
        
        function clearGroupSelect () {
            dirtyGroupSelect = false;
            groupSelect.setEnabled(false);
            groupSelect.updateItems([dangerousGoodsOption]);
        }
        
        function pushChangeOohSelect() {
            oohInput.dispatchEvent(new CustomEvent('changeOohSelect'));
        }

        oohInput.addEventListener('keyup', function () {
            const value = this.value;
            oohSelectWrapper.innerHTML = '';
            oohSelect.hide();
            
            if (dirtyGroupSelect) {
                clearGroupSelect();
            }
            
            if (value.length >= 3) {
                const newSelectItems = dangerousGoodsKeys
                    .filter(key => key.startsWith(value))
                    .map(key => ({ text: dangerousGoods[key].shippingName, value: key }));
                
                if (newSelectItems.length) {
                    oohSelect.updateItems(newSelectItems);
                    oohSelect.value = '';
                    pushChangeOohSelect();
                    oohSelect.show();
                }
            }
        });
        
        groupSelect.setEnabled(false);
        oohSelect.input.addEventListener('change', function () {
            dangerousGoodsSelected = dangerousGoods[this.value];
            const packingGroup = dangerousGoodsSelected.packingGroup || [];
            
            oohInput.value = this.value;
            groupSelect.updateItems([dangerousGoodsOption, ...packingGroup.map(value => ({ value, text: dangerousGoodsGroups[value] }))]);
            groupSelect.setEnabled(packingGroup.length);
            pushChangeOohSelect();
            dirtyGroupSelect = true;
        });

        let tableSelects = [];
        function renderTablePermission() {
            permissionsHtml.style.display = 'none';
            tablePermissionsHtml.innerHTML = '';
            tableSelects = [];

            const hasOneElement = tablePermissions.length === 1;
            
            tablePermissions.forEach(({ permission, dangerousGoodsSelected: { checkByName, items } }, idx) => {
                const { code, packingGroup } = permission;
                permission.dangerousSubstanceId = "";
                
                const row = document.createElement('tr');
                const selectHtml = (items.length && (!hasOneElement || checkByName)) ? 
                    permissionsSelectTemplate
                        .replace('{{ select-id }}', `permission-card-select-${idx}`)
                        .replace('{{ select-items }}', items.map(({ dangerousSubstanceId, dangerousSubstanceName }) => `<div class="select__item btn btn_secondary" data-value="${dangerousSubstanceId}">${dangerousSubstanceName}</div>`).join('')) 
                    : ''

                row.innerHTML = permissionsRowTemplate
                    .replace('{{ pos }}', `${idx + 1}`)
                    .replace('{{ code }}', code)
                    .replace('{{ packingGroup }}', packingGroup? dangerousGoodsGroups[packingGroup] : window['dangerousGoodsGroupsNotSelected'])
                    .replace('{{ select }}', selectHtml);

                tablePermissionsHtml.append(row);
                
                row.querySelector('.dangerous-goods__cross-wrapper').addEventListener('click', () => {
                    tablePermissions.splice(idx, 1);
                    renderTablePermission();
                })
                
                const selectEl = row.querySelector('.select');
                if (selectEl) {
                    const select = new Select(selectEl);

                    select.select.addEventListener('change', function () {
                        permission.dangerousSubstanceId = select.value;
                        if (select.value === '0') {
                            this.classList.add('error');
                        }
                        else {
                            this.classList.remove('error');
                        }
                        
                        updatePosPermissionSelect();
                    })
                }
            })
            
            tableWrapper.style.display = '';
            updatePosPermissionSelect();
        }

        const form = document.querySelector('#permission-form');
        let isEnableShowErrors = true;
        form.addEventListener('submit', event => {
            event.preventDefault();
            isEnableShowErrors = true;

            const permission = formValidate(form, {
                code: {
                    type: 'input',
                    events: ['changeOohSelect'],
                    validate: () => !oohSelect.value && isEnableShowErrors
                },
                packingGroup: {
                    type: 'select',
                    validate: value => groupSelect.isEnable && !value
                }
            }, false);

            if (permission) {
                clearGroupSelect();
                oohInput.value = oohSelect.value = '';
                masks[1].iMask.updateValue();
                isEnableShowErrors = false;
                tablePermissions.push({ permission, dangerousGoodsSelected });
                renderTablePermission();
            }
        });

        function updatePosPermissionSelect() {
            $('[data-permission-card-select]').each((_, el) => {
                const target = $(el);
                const { top, left } = target.offset();
                const wrapper = target.find('.select__wrapper');

                wrapper.css({
                    position: 'fixed',
                    top: `${top - $(window).scrollTop() + 30}px`,
                    left: `${left - 1}px`
                })
            });
        }

        document.querySelector('.table-wrapper')?.addEventListener('scroll', updatePosPermissionSelect);
        window.addEventListener('scroll', updatePosPermissionSelect);
        window.addEventListener('resize', updatePosPermissionSelect);
        
        document.querySelector('#request-permission').addEventListener('click', () => {
            const result = formValidate(dangerousGoodsForm, {
                surname: {
                    type: 'input',
                    validate: 'abs|required'
                },
                name: {
                    type: 'input',
                    validate: 'abs|required'
                },
                patronymic: {
                    type: 'input',
                    validate: 'abs|required'
                },
                phone: {
                    type: 'input',
                    validate: 'length:18'
                },
                email: {
                    type: 'input',
                    validate: 'email'
                }
            }, true);

            permissionsHtml.style.display = 'none';
            fetch(`${window.config.host}/ajax/dangerous_goods.php`, {
                method: 'POST',
                body: JSON.stringify({ ...result, unCodes: tablePermissions.map(el => el.permission)})
            })
                .then(response => response.json())
                .then((result) => {
                    if (result.items && result.items.length) {
                        renderPermissions(result.items);
                    }
                });
            })

        const replacePermissionKeys = ['shippingName', 'tankerInstructions', 'receptionByRailway', 'portDescription', 'classOrSubclass', 'unCode', 'additionalInformation', 'packingGroup', 'cargoProperties'];
        function renderPermissions(permissions) {
            permissionsHtml.innerHTML = '';

            console.log(permissions)
            permissions.forEach(permission => {
                const newPermission = document.createElement('div');
                let result = permissionsTemplate;
                replacePermissionKeys.forEach(key => result = result.replace(`{{ ${key} }}`, permission[key]));
                
                const { color, text, additional_text, disableCard } = permission.status;
                let footer = `<div class="dangerous-goods-permission__status" style="color: ${color}">${text}</div>`;

                if (additional_text) {
                    footer += `<div class="dangerous-goods-permission__depiction">${additional_text}</div>`
                }

                newPermission.innerHTML = result.replace('{{ footer }}', footer);
                
                newPermission.classList.add('dangerous-goods-permission');
                if (disableCard) {
                    newPermission.classList.add('failure');
                }
                
                permissionsHtml.append(newPermission);
            })
            
            permissionsHtml.style.display = '';
        }
    })
</script>